// === é™åˆ¶æ¯äººä¸€æ¬¡ç‰ˆ ===

const PRIZES = [
  { id: 0, name: "è°¢è°¢å‚ä¸", color: "#f7f7f7", fontColor: "#333", probability: 0.5, isPrize: false },
  { id: 1, name: "10å…ƒä»£é‡‘åˆ¸", color: "#ffec99", fontColor: "#d9480f", probability: 0.3, isPrize: true, prefix: "C10-" },
  { id: 2, name: "VIP 7å¤©ä½“éªŒ", color: "#e3fafc", fontColor: "#1098ad", probability: 0.15, isPrize: true, prefix: "VIP7-" },
  { id: 3, name: "iPhone 15", color: "#ff8787", fontColor: "#fff", probability: 0.05, isPrize: true, prefix: "IPH-" },
];

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // å¤„ç†æŠ½å¥–æ¥å£
    if (url.pathname === "/api/draw" && request.method === "POST") {
      return handleDraw(request, env);
    }

    // è¿”å›ç½‘é¡µ
    return handleHtml();
  },
};

// åç«¯ï¼šæŠ½å¥–é€»è¾‘ (å¸¦èº«ä»½éªŒè¯)
async function handleDraw(request, env) {
  // 1. è·å–ç”¨æˆ· IP åœ°å€
  const clientIP = request.headers.get("CF-Connecting-IP") || "0.0.0.0";
  
  // 2. æ£€æŸ¥æ•°æ®åº“ï¼Œçœ‹è¿™ä¸ª IP æ˜¯å¦å­˜åœ¨
  // å¦‚æœä½ åœ¨ç¬¬äºŒæ­¥æ²¡æœ‰æ­£ç¡®ç»‘å®š KVï¼Œè¿™é‡Œä¼šæŠ¥é”™
  const history = await env.DB.get(clientIP);

  if (history) {
    // å¦‚æœå·²ç»æŠ½è¿‡äº†ï¼Œç›´æ¥è¿”å›å†å²ç»“æœ
    const oldData = JSON.parse(history);
    return new Response(JSON.stringify({
      success: false,
      message: "æ‚¨å·²ç»æŠ½è¿‡å¥–äº†ï¼",
      oldPrize: oldData.prizeName,
      oldCode: oldData.code
    }), { headers: { "Content-Type": "application/json" } });
  }

  // 3. å¼€å§‹æ­£å¸¸æŠ½å¥–
  const random = Math.random();
  let accumulatedProbability = 0;
  let selectedPrize = PRIZES[0];

  for (const prize of PRIZES) {
    accumulatedProbability += prize.probability;
    if (random <= accumulatedProbability) {
      selectedPrize = prize;
      break;
    }
  }

  let cardCode = null;
  if (selectedPrize.isPrize) {
    const timestamp = Date.now().toString().slice(-4);
    const randomStr = Math.random().toString(36).substring(2, 6).toUpperCase();
    cardCode = selectedPrize.prefix + timestamp + randomStr;
  }

  // 4. å°†æŠ½å¥–ç»“æœå†™å…¥æ•°æ®åº“ (æ°¸ä¹…è®°å½•ï¼Œæˆ–è€…è®¾ç½®è¿‡æœŸæ—¶é—´)
  const resultData = {
    prizeName: selectedPrize.name,
    code: cardCode,
    time: Date.now()
  };
  
  // å†™å…¥ KVï¼Œé”®æ˜¯ IPï¼Œå€¼æ˜¯ç»“æœ
  await env.DB.put(clientIP, JSON.stringify(resultData));

  return new Response(JSON.stringify({
    success: true,
    prizeIndex: selectedPrize.id,
    prizeName: selectedPrize.name,
    code: cardCode
  }), {
    headers: { "Content-Type": "application/json" }
  });
}

// å‰ç«¯ï¼šç½‘é¡µä»£ç 
async function handleHtml() {
  const segmentDegree = 360 / PRIZES.length;
  let conicGradient = PRIZES.map((p, i) => 
    p.color + " " + (i * segmentDegree) + "deg " + ((i + 1) * segmentDegree) + "deg"
  ).join(", ");

  const labelsHtml = PRIZES.map((p, i) => {
    const rotation = (360 / PRIZES.length) * i + (360 / PRIZES.length) / 2;
    return '<div class="label" style="transform: rotate(' + rotation + 'deg) translateY(-50%); color: ' + p.fontColor + '">' + p.name + '</div>';
  }).join('');

  const html = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸è¿å¡å¯†æŠ½å¥–</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #222; color: #fff; }
        h1 { margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .wheel-container { position: relative; width: 300px; height: 300px; margin-bottom: 30px; }
        .wheel {
            width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(${conicGradient});
            border: 8px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
        }
        .wheel-labels { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .label {
            position: absolute; left: 50%; top: 50%;
            transform-origin: 0 0;
            font-size: 14px; font-weight: bold; width: 150px;
            text-align: right; padding-right: 20px; box-sizing: border-box;
        }
        .pointer {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-top: 30px solid #ff0055; z-index: 10;
        }
        button {
            padding: 12px 30px; font-size: 18px; border: none; border-radius: 50px;
            background: linear-gradient(45deg, #ff0055, #ff5500); color: white;
            cursor: pointer; box-shadow: 0 4px 15px rgba(255, 0, 85, 0.4);
            transition: transform 0.2s;
        }
        button:active { transform: scale(0.95); }
        button:disabled { background: #555; cursor: not-allowed; }
        #result { margin-top: 20px; font-size: 1.2em; min-height: 1.5em; text-align: center; }
        .code-display { 
            display: block; margin-top: 10px; padding: 10px; 
            background: #333; border: 1px dashed #666; color: #4ade80; 
            font-family: monospace; letter-spacing: 1px; font-size: 1.2em;
        }
        .error-msg { color: #ff6b6b; font-weight: bold; padding: 10px; background: rgba(255,0,0,0.1); border-radius: 8px; }
    </style>
</head>
<body>

    <h1>âœ¨ å¹¸è¿å¤§è½¬ç›˜ âœ¨</h1>

    <div class="wheel-container">
        <div class="pointer"></div>
        <div class="wheel" id="wheel"></div>
        <div class="wheel-labels">
            ${labelsHtml}
        </div>
    </div>

    <button id="spinBtn" onclick="spin()">å¼€å§‹æŠ½å¥–</button>
    <div id="result"></div>

    <script>
        const wheel = document.getElementById('wheel');
        const resultDiv = document.getElementById('result');
        const spinBtn = document.getElementById('spinBtn');
        let currentRotation = 0;
        const totalPrizes = ${PRIZES.length};

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœ¬åœ°è®°å½• (ä½œä¸ºç¬¬ä¸€é“é˜²çº¿ï¼Œè™½é˜²å›å­ä¸é˜²å°äººï¼Œä½†ä½“éªŒå¥½)
        if (localStorage.getItem('hasDrawn')) {
             spinBtn.disabled = true;
             spinBtn.innerText = "æ‚¨å·²æŠ½è¿‡";
             resultDiv.innerHTML = '<div class="error-msg">æ‚¨å·²ç»å‚ä¸è¿‡æ´»åŠ¨äº†</div>';
        }

        async function spin() {
            spinBtn.disabled = true;
            resultDiv.innerHTML = 'æ­£åœ¨è·å–ç»“æœ...';

            try {
                const res = await fetch('/api/draw', { method: 'POST' });
                const data = await res.json();
                
                // å¤„ç†â€œå·²ç»æŠ½è¿‡â€çš„æƒ…å†µ
                if (data.success === false) {
                    resultDiv.innerHTML = '<div class="error-msg">' + data.message + '</div>';
                    if(data.oldCode) {
                         resultDiv.innerHTML += '<br>æ‚¨ä¸Šæ¬¡æŠ½ä¸­çš„æ˜¯: ' + data.oldPrize + '<br><span class="code-display">' + data.oldCode + '</span>';
                    }
                    localStorage.setItem('hasDrawn', 'true');
                    return;
                }

                // æ­£å¸¸æŠ½å¥–åŠ¨ç”»é€»è¾‘
                localStorage.setItem('hasDrawn', 'true'); // æ ‡è®°æœ¬åœ°
                resultDiv.innerHTML = ''; // æ¸…ç©ºç­‰å¾…æ–‡å­—
                
                const segmentDeg = 360 / totalPrizes;
                const targetIndex = data.prizeIndex;
                const extraSpins = 360 * 5; 
                const stopAngle = -(targetIndex * segmentDeg + segmentDeg / 2); 
                
                currentRotation += extraSpins + stopAngle - (currentRotation % 360);
                
                wheel.style.transform = 'rotate(' + currentRotation + 'deg)';

                setTimeout(() => {
                    spinBtn.disabled = false;
                    spinBtn.innerText = "æŠ½å¥–ç»“æŸ";
                    spinBtn.onclick = null; // ç§»é™¤ç‚¹å‡»äº‹ä»¶
                    
                    if (data.code) {
                        resultDiv.innerHTML = 'ğŸ‰ æ­å–œï¼æŠ½ä¸­ <strong>' + data.prizeName + '</strong><br><span class="code-display">å¡å¯†: ' + data.code + '</span>';
                    } else {
                        resultDiv.innerHTML = 'ğŸ’¨ å“å‘€ï¼Œ' + data.prizeName + 'ï¼Œä¸‹æ¬¡å¥½è¿ï¼';
                    }
                }, 4000);

            } catch (err) {
                console.error(err);
                alert('ç½‘ç»œé”™è¯¯');
                spinBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
  `;

  return new Response(html, {
    headers: { "Content-Type": "text/html;charset=UTF-8" }
  });
}