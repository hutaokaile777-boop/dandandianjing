<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸è¿å¤§è½¬ç›˜ - 21äº‘ç‰ˆ</title>
    <style>
        body { font-family: 'PingFang SC', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #1a1a2e; color: #fff; }
        .wheel-container { position: relative; width: 300px; height: 300px; margin-bottom: 30px; }
        .wheel { width: 100%; height: 100%; border-radius: 50%; border: 8px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); }
        .pointer { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid #ff0055; z-index: 10; }
        button { padding: 15px 40px; font-size: 18px; border: none; border-radius: 50px; background: linear-gradient(45deg, #ff0055, #ff5500); color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 0, 85, 0.3); }
        button:disabled { background: #555; cursor: not-allowed; }
        #result { margin-top: 25px; text-align: center; min-height: 80px; }
        .code-box { display: block; margin-top: 10px; padding: 12px; background: #2a2a4e; border: 1px dashed #4ade80; color: #4ade80; font-family: monospace; }
    </style>
</head>
<body>
    <h1>âœ¨ å¹¸è¿æŠ½å¥– âœ¨</h1>
    <div class="wheel-container">
        <div class="pointer"></div>
        <div class="wheel" id="wheel"></div>
    </div>
    <button id="spinBtn" onclick="spin()">ç‚¹å‡»æŠ½å¥–</button>
    <div id="result"></div>

    <script>
        const PRIZES = [
            { name: "è°¢è°¢å‚ä¸", color: "#f8f9fa" },
            { name: "10å…ƒä»£é‡‘åˆ¸", color: "#ffe066" },
            { name: "VIP 7å¤©å¡", color: "#e3fafc" },
            { name: "iPhone 15", color: "#ff8787" }
        ];

        // ã€å…³é”®é…ç½®ã€‘ï¼šè¯·æŠŠä¸‹é¢çš„é“¾æ¥æ”¹ä¸ºä½ çœŸæ­£çš„ Cloudflare Worker ç½‘å€
        const API_URL = 'https://lucky-app.hutaokaile777.workers.dev/api/draw';

        const wheel = document.getElementById('wheel');
        const resultDiv = document.getElementById('result');
        const spinBtn = document.getElementById('spinBtn');
        let currentRotation = 0;

        const segment = 360 / PRIZES.length;
        wheel.style.background = `conic-gradient(${PRIZES.map((p, i) => `${p.color} ${i*segment}deg ${(i+1)*segment}deg`).join(', ')})`;

        async function spin() {
            if (spinBtn.disabled) return;
            spinBtn.disabled = true;
            resultDiv.innerText = "æ­£åœ¨è·å–æŠ½å¥–ç»“æœ...";

            try {
                // ç›´æ¥å‘ Cloudflare å‘é€è¯·æ±‚ï¼Œä¸å†é€šè¿‡ Vercel
                const response = await fetch(API_URL, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (!data.success) {
                    resultDiv.innerHTML = `<b style="color:#ffae00">${data.message}</b><br>${data.oldPrize ? 'ç»“æœ: ' + data.oldPrize : ''} ${data.oldCode ? '<span class="code-box">'+data.oldCode+'</span>' : ''}`;
                    return;
                }

                // æ—‹è½¬é€»è¾‘ï¼šç¡®ä¿æ¯æ¬¡éƒ½é¡ºæ—¶é’ˆæ—‹è½¬ï¼Œä¸”åŠ¨ç”»åœåœ¨æ­£ç¡®çš„ä½ç½®
                const extraSpin = 360 * 5; // åŸºç¡€è½¬5åœˆ
                const targetAngle = 360 - (data.prizeIndex * segment + segment / 2);
                currentRotation = Math.ceil(currentRotation / 360) * 360 + extraSpin + targetAngle;
                
                wheel.style.transform = `rotate(${currentRotation}deg)`;

                setTimeout(() => {
                    resultDiv.innerHTML = `ğŸ‰ æ­å–œä¸­å¥–: <strong>${data.prizeName}</strong> ${data.code ? '<span class="code-box">'+data.code+'</span>' : ''}`;
                }, 4000);

            } catch (e) {
                console.error(e);
                resultDiv.innerText = "ç½‘ç»œè¶…æ—¶ï¼Œè¯·æ£€æŸ¥ Cloudflare Worker è·¨åŸŸè®¾ç½®";
                spinBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
